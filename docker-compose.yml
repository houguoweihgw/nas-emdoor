version: '3'
services:
  nas-front-end:
    build:
      context: ./nas-fronted
    ports:
      - "8082:80"
    depends_on:
      - nas-back-end
    environment:
      BACK_HOST: nas-back-end

  nas-back-end:
    build:
      context: ./nas-backend
    ports:
      - "8001:8001"
    depends_on:
      - nas-mysql
      - nas-redis
      - nas-nats
    environment:
      DB_HOST: nas-mysql
      REDIS_HOST: nas-redis
      NATS_HOST: nas-nats
    volumes:
      - ./database/nas-data:/backnas/nas-data

  nas-algorithm:
    build:
      context: ./nas-algorithm
    depends_on:
      - nas-nats
    environment:
      NATS_HOST: nas-nats

  nas-mysql:
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: admin123
    ports:
      - "3306:3306"
    volumes:
      - ./database/mysql/data:/var/lib/mysql
      - ./database/mysql/logs:/var/log/mysql
      - ./database/mysql/mysql-files:/var/lib/mysql-files
      - ./database/mysql/conf:/etc/mysql
      - ./database/mysql/my.cnf:/etc/mysql/my.cnf
      - ./database/mysql/sql:/docker-entrypoint-initdb.d  # 挂载初始化脚本

  nas-redis:
    image: redis:latest
    ports:
      - "6379:6379"
    volumes:
      - ./database/redis/redis.conf:/etc/redis/redis.conf
      - ./database/redis/data:/data

  nas-nats:
    image: nats:latest
    ports:
      - "4222:4222"
      - "8222:8222"
      - "6222:6222"
    volumes:
      - ./nats-server.conf:/nats-server.conf